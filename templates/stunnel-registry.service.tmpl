[Unit]
Description=Launch Stunnel for private registry access
After=docker.service

[Service]
Restart=on-failure
RestartSec=1s
StartLimitInterval=300s
StartLimitBurst=3
TimeoutStartSec=0
EnvironmentFile=/etc/environment
Environment=CONF=/etc/stunnel/stunnel-registry-client.conf

ExecStartPre=/bin/sh -c '/usr/bin/docker pull {{.PemImage}}'
ExecStartPre=/bin/sh -c '/usr/bin/docker pull {{.Image}}'
ExecStartPre=-/usr/bin/docker stop stunnel-registry
ExecStartPre=-/usr/bin/docker rm -f stunnel-registry
ExecStartPre=-/usr/bin/docker stop stunnel-registry-pem
ExecStartPre=-/usr/bin/docker rm -f stunnel-registry-pem
ExecStartPre=/usr/bin/docker run -d --name stunnel-registry-pem -e PASSPHRASE={{quote .PemPassphrase}} {{.PemImage}}
ExecStartPre=/bin/sh -c 'sleep 5'
ExecStart=/usr/bin/docker run --rm --name stunnel-registry -p 127.0.0.1:5000:5000 --volumes-from stunnel-registry-pem -v {{.ConfPath}}:${CONF} {{.Image}} ${CONF}

ExecStop=-/usr/bin/docker stop stunnel-registry
ExecStopPost=-/usr/bin/docker rm -f stunnel-registry
ExecStopPost=-/usr/bin/docker stop stunnel-registry-pem
ExecStopPost=-/usr/bin/docker rm -f stunnel-registry-pem

[Install]
WantedBy=multi-user.target
